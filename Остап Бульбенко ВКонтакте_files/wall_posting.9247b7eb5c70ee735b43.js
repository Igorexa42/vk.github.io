(self.webpackChunkvk=self.webpackChunkvk||[]).push([[9567],{41281:function(e,t,s){"use strict";var i=s(75105);window.BestFriends=new class{constructor(){this.onCountChange=(0,i.default)(),this.isCountWasChanged=!1,this.count=0}updateCount(e){this.isCountWasChanged=!0,this.count=e,this.onCountChange(e)}getCount(){return this.count}};var n=s(93736),r=s(39871),o=s(49598),d=s(59336),a=s(10934),l=s(81294),c=s(62641);var h=s(93156);var u=s(31931),F=s(90893),v=s(20221);function f(e={}){var t=!e.isAllConversationsLoaded&&!e.isSearchMode,s=!e.isSearchMode,i=e.conversationsList&&e.conversationsList.length?[(0,d.default)(),(0,v.default)({inner:[e.conversationsList.map((t=>function(e={}){var t=e.conversation||{},s=t.userIds&&t.userIds.length||0,i=(0,c.getLangNumeric)(s,(0,c.getLang)("mobile_best_friends_edit_box_conversation_friends_count","raw")),n=!e.isSelected&&!e.isAddBestFriendsAvailable,r=(0,c.classNames)("BestFriendsEditBoxConversationItem","BestFriendsEditBoxItem",{"BestFriendsEditBoxConversationItem--selected":e.isSelected,"BestFriendsEditBoxConversationItem--disabled":n}),o=e.isSelected?(0,c.getLang)("mobile_best_friends_edit_box_conversation_delete_button_text"):(0,c.getLang)("mobile_best_friends_edit_box_conversation_add_button_text");return(0,a.OwnerRow)({mix:r,attrs:{"data-conversation-id":t.peerId},onClick:[e.onConversationActionClick,t.peerId],img:t.photoUrl,title:Wd.wrap(t.name),subtitle:i,link:e.isSearchMode?null:(0,l.default)({inner:[o],disabled:n,class:"BestFriendsEditBoxConversationItem__actionButton",theme:e.isSelected?"tertiary":"outline"})})}({conversation:t,isSelected:(0,c.arrayIncludes)(e.selectedConversationsIds,t.peerId),isSearchMode:e.isSearchMode,isAddBestFriendsAvailable:e.isAddBestFriendsAvailable,onConversationActionClick:e.onConversationActionClick}))),t?(0,l.default)({inner:[(0,c.getLangNumeric)(e.moreConversationsCount,(0,c.getLang)("mobile_best_friends_edit_box_conversations_load_more_button_text","raw"))],theme:"tertiary",class:"BestFriendsEditBoxSource__loadMoreButton",icon:(0,h.Icon28ChevronDownOutline)(),onClick:e.onLoadMoreConversationsClick,use_native_onclick:!0}):null],mix:"BestFriendsEditBoxSource BestFriendsEditBoxSource--conversations",no_caps_for_title:!0,title:(0,c.getLang)("mobile_best_friends_edit_box_conversations_header")})]:null,n=e.friendsList&&e.friendsList.length?[(0,d.default)(),(0,v.default)({inner:[e.friendsList.map((t=>function(e={}){var t=e.friend||{},s=!e.isSelected&&!e.isAddBestFriendsAvailable,i=(0,c.classNames)("BestFriendsEditBoxFriendItem","BestFriendsEditBoxItem",{"BestFriendsEditBoxFriendItem--selected":e.isSelected,"BestFriendsEditBoxFriendItem--disabled":s}),n=(0,c.classNames)("BestFriendsEditBoxFriendItem__checkbox",{"BestFriendsEditBoxFriendItem__checkbox--checked":e.isSelected,"BestFriendsEditBoxFriendItem__checkbox--disabled":s});return(0,a.OwnerRow)({mix:i,attrs:{"data-friend-id":t.id},onClick:[e.onFriendActionClick,t.id],img:t.photoUrl,title:Wd.wrap(t.name),link:e.isSearchMode?null:{inner:[e.isSelected?(0,h.Icon24CheckCircleOn)():(0,h.Icon24CheckCircleOff)()],class:n,tag:"div"}})}({friend:t,isSelected:(0,c.arrayIncludes)(e.bestFriendsIds,t.id),isSearchMode:e.isSearchMode,isAddBestFriendsAvailable:e.isAddBestFriendsAvailable,onFriendActionClick:e.onFriendActionClick})))],mix:"BestFriendsEditBoxSource BestFriendsEditBoxSource--friends",no_caps_for_title:!0,corner:s?{onclick:e.onClearBestFriendsButtonClick,text:(0,c.getLang)("mobile_best_friends_edit_box_best_friends_clear_button_text"),class:"BestFriendsEditBoxSource__headerAction"}:null,title:(0,c.getLang)("mobile_best_friends_edit_box_friends_header")})]:null;return{inner:[e.isDataLoaded?null:{inner:[(0,u.default)()],class:"BestFriendsEditBox__locker",tag:"div"},e.isDataLoaded?{inner:[(0,F.default)({mix:"BestFriendsEditBoxSearchInput",on_change:e.onSearchInputChange,value:e.query,icon:(0,h.Icon16Search)(),placeholder:(0,c.getLang)("mobile_best_friends_edit_box_search_input_label")}),e.isSearchNotFound?null:{inner:[(0,c.getLang)("mobile_best_friends_edit_box_description")],class:"BestFriendsEditBox__description",tag:"div"},i,n],class:"BestFriendsEditBox__content",tag:"div"}:null,e.isSearchNotFound?{inner:[(0,c.getLang)("mobile_best_friends_edit_box_search_not_found")],class:"BestFriendsEditBoxSearchNotFound",tag:"div"}:null],class:"BestFriendsEditBox",ref:e.bestFriendsEditBoxRef,tag:"div"}}const B=100;var _;!function(e){e.ADD="add",e.DELETE="delete"}(_||(_={}));var C=s(2947),m=s(20848),g=s(80235),b=s(57141),L=s(40983);class p extends C.Component{constructor(e){super(e),this.nextFriendsStartFrom=40,this.nextConversationsStartFrom=2,this.onStateChange=(0,i.default)(),this.bestFriendsEditBoxRef=(0,C.createRef)(),this.setSubmitButtonDisabled=(e=!0)=>{const t=this.bestFriendsEditBoxRef?.current.closest(".ModalPage").querySelector(".ModalPage__headerButton--confirm");t&&l.default.setDisabled(t,e)},this.loadMoreFriends=()=>new Promise((e=>{if(this.state.isAllFriendsLoaded||this.state.isSearchMode)return;const t=this.data.friendsList.slice(this.nextFriendsStartFrom,this.nextFriendsStartFrom+40),s=this.mergeFriendsLists(this.state.friendsList,t);this.setState({friendsList:s,isAllFriendsLoaded:s.length>=this.data.friendsList.length}),this.nextFriendsStartFrom=this.nextFriendsStartFrom+40,e()})),this.loadMoreConversations=()=>{if(this.state.isAllConversationsLoaded)return;const e=this.data.conversationsList.slice(this.nextConversationsStartFrom,this.nextConversationsStartFrom+5),t=this.mergeConversationsList(this.state.conversationsList,e);this.setState({conversationsList:t,isAllConversationsLoaded:t.length>=this.data.conversationsList.length,moreConversationsCount:this.getMoreConversationsCount(this.data.conversationsList.length,t.length)}),this.nextConversationsStartFrom=this.nextConversationsStartFrom+5},this.search=e=>{let t=e.currentTarget.value;return this.state.isSearchMode||(t=t.trim(),""!==t)?new Promise((e=>{if("string"!=typeof t||0===t.length)return void this.endSearch(e);this.conversationsListBeforeSearch||(this.conversationsListBeforeSearch=this.state.conversationsList),this.friendsListBeforeSearch||(this.friendsListBeforeSearch=this.state.friendsList);const s=this.data.conversationsList.filter((e=>e.name.toLowerCase().includes(t.toLowerCase().trim()))),i=this.data.friendsList.filter((e=>e.name.toLowerCase().includes(t.toLowerCase().trim())));this.setState({query:t,isSearchMode:!0,isSearchNotFound:!s.length&&!i.length,conversationsList:s,friendsList:i}),e()})):(this.setState({query:t}),Promise.resolve())},this.removeBestFriend=e=>{const t=this.state.bestFriendsIds.filter((t=>t!==e));this.setState({bestFriendsIds:t,isAddBestFriendsAvailable:t.length<B,selectedConversationsIds:this.getConversationsIdsWhereAllFriendsExists(t)})},this.addBestFriend=(e,t=!1)=>{let s=this.state.friendsList;if(t){const t=this.data.friendsList.find((t=>t.id===e));s=this.getFriendsListOrderedByFriendsIds(this.mergeFriendsLists(t?[t]:[],this.state.friendsList),[e])}const i=Array.from(new Set(this.state.bestFriendsIds.concat(e)));this.setState({friendsList:s,bestFriendsIds:i,isAddBestFriendsAvailable:i.length<B,selectedConversationsIds:this.getConversationsIdsWhereAllFriendsExists(i)})},this.isBestFriendSelected=e=>this.state.bestFriendsIds.includes(e),this.removeBestFriendsFromConversation=e=>{const t=this.data.conversationsList.find((t=>t.peerId===e));if(!t)return;const s=this.state.bestFriendsIds.filter((e=>!t.userIds.includes(e)));this.setState({bestFriendsIds:s,isAddBestFriendsAvailable:s.length<B,selectedConversationsIds:this.getConversationsIdsWhereAllFriendsExists(s)})},this.addBestFriendsFromConversation=(e,t=!1)=>{const s=this.data.conversationsList.find((t=>t.peerId===e));if(!s)return;let i=this.state.conversationsList;t&&(i=this.getConversationsListOrderedByConversationsIds(this.mergeConversationsList(this.state.conversationsList,[s]),[e]));const n=this.getFriendsListOrderedByFriendsIds(this.mergeFriendsLists(this.data.friendsList.filter((e=>s.userIds.includes(e.id))).sort(((e,t)=>e.id-t.id)),this.state.friendsList),s.userIds),r=Array.from(new Set(this.state.bestFriendsIds.concat(s.userIds)));this.setState({conversationsList:i,isAllConversationsLoaded:i.length>=this.data.conversationsList.length,friendsList:n,bestFriendsIds:r,isAddBestFriendsAvailable:r.length<B,selectedConversationsIds:this.getConversationsIdsWhereAllFriendsExists(r)})},this.isConversationSelected=e=>this.state.selectedConversationsIds.includes(e),this.clearBestFriendsList=()=>{this.setState({bestFriendsIds:[],isAddBestFriendsAvailable:!0,selectedConversationsIds:[]})},this.submit=()=>{(0,g.sendBestFriendsAnalytic)(g.BestFriendsEventType.saveBestFriendsList);const{bestFriendsIds:e}=this.state;let t=null;const s=(e=!1)=>{e&&(0,g.sendBestFriendsAnalytic)(g.BestFriendsEventType.updatePopupSave),t&&o.default.close(t),this.setSubmitButtonDisabled(),this.saveBestFriends().then((e=>{window.BestFriendsEditBox?.closePopup(),this.config.showSuccessSnackbar&&b.init({type:b.SNACKBAR_TYPE_SUCCESS,text:(0,c.getLang)("mobile_best_friends_list_saved")}),window.BestFriends?.updateCount(e.bestFriendsCount),r.default.handle(this.config?.onSubmit,e)})).catch(console.error)};e.length?t=(0,L.Confirm)((0,c.getLang)("mobile_wall_best_friends_settings_box_confirm_description"),(()=>s(!0)),(()=>{(0,g.sendBestFriendsAnalytic)(g.BestFriendsEventType.updatePopupCancel),t&&o.default.close(t)}),{yes_label:(0,c.getLang)("mobile_wall_best_friends_settings_box_confirm_save_label"),title:(0,c.getLang)("mobile_wall_best_friends_settings_box_confirm_save")}):s()},this.onConversationActionClick=e=>{const{isAddBestFriendsAvailable:t,isSearchMode:s}=this.state;if(s)return(0,g.sendBestFriendsAnalytic)(g.BestFriendsEventType.selectChatFromSearch),void this.endSearch((()=>{t&&(this.addBestFriendsFromConversation(e,!0),this.animateReorderedItems(this.getFriendsIdsFromConversations(e),"data-friend-id"),this.animateReorderedItems([e],"data-conversation-id"))}));(0,g.sendBestFriendsAnalytic)(g.BestFriendsEventType.addFriendsFromChat),this.isConversationSelected(e)?this.removeBestFriendsFromConversation(e):t&&(this.addBestFriendsFromConversation(e),this.animateReorderedItems(this.getFriendsIdsFromConversations(e),"data-friend-id"))},this.onFriendActionClick=e=>{const{isAddBestFriendsAvailable:t,isSearchMode:s}=this.state;if(s)return(0,g.sendBestFriendsAnalytic)(g.BestFriendsEventType.selectFriendFromSearch),void this.endSearch((()=>{t&&(this.addBestFriend(e,!0),this.animateReorderedItems([e],"data-friend-id"))}));this.isBestFriendSelected(e)?this.removeBestFriend(e):t&&this.addBestFriend(e)},this.onLoadMoreConversationsClick=()=>{(0,g.sendBestFriendsAnalytic)(g.BestFriendsEventType.moreChats),this.loadMoreConversations()},this.onClearBestFriendsButtonClick=()=>{(0,g.sendBestFriendsAnalytic)(g.BestFriendsEventType.clear),this.clearBestFriendsList()},this.config=this.props.config,this.state={bestFriendsIds:[],isAddBestFriendsAvailable:!0,selectedConversationsIds:[],friendsList:[],totalFriendsCount:0,isAllFriendsLoaded:!1,conversationsList:[],totalConversationsCount:0,isAllConversationsLoaded:!1,moreConversationsCount:0,query:"",isSearchMode:!1,isSearchNotFound:!1,isDataLoaded:!1}}componentDidMount(){this.addSubmitButtonClickListener(),this.setSubmitButtonDisabled(),this.initAutoScroll(),this.loadData().then((e=>{this.data=this.prepareData(e);const t=this.data.bestFriendsIds.length?this.data.bestFriendsIds:this.data.friendsList.slice(0,10).map((e=>e.id));this.setState({bestFriendsIds:t,isAddBestFriendsAvailable:t.length<B,selectedConversationsIds:this.getConversationsIdsWhereAllFriendsExists(this.data.bestFriendsIds),friendsList:this.data.friendsList.slice(0,40),totalFriendsCount:this.data.friendsList.length,isAllFriendsLoaded:this.data.friendsList.length<=40,conversationsList:this.data.conversationsList.slice(0,2),totalConversationsCount:this.data.conversationsList.length,isAllConversationsLoaded:this.data.conversationsList.length<=2,moreConversationsCount:this.getMoreConversationsCount(this.data.conversationsList.length,2),isDataLoaded:!0})})).catch(console.error)}componentWillUpdate(e,t){this.setSubmitButtonDisabled(!this.isSubmitAvailable(t))}addSubmitButtonClickListener(){const e=this.bestFriendsEditBoxRef?.current.closest(".ModalPage").querySelector(".ModalPage__headerButton--confirm");e?.addEventListener("click",this.submit)}initAutoScroll(){let e=null;this.bestFriendsEditBoxRef?.current.closest(".ModalPage__content")?.addEventListener("scroll",(t=>{e?.((0,m.getY)(t.currentTarget)+t.currentTarget.scrollTop)})),(0,m.initAutoScroll)((()=>{const e=this.bestFriendsEditBoxRef?.current.querySelectorAll(".BestFriendsEditBoxSource--friends .BestFriendsEditBoxFriendItem");if(e)return e[e.length-1]}),this.loadMoreFriends,{onScroll:t=>e=t})}endSearch(e){this.setState({query:"",isSearchMode:!1,isSearchNotFound:!1,conversationsList:this.conversationsListBeforeSearch,friendsList:this.friendsListBeforeSearch},e),delete this.conversationsListBeforeSearch,delete this.friendsListBeforeSearch}animateReorderedItems(e,t){requestAnimationFrame((()=>{e.map((e=>{const s=this.bestFriendsEditBoxRef?.current.querySelector(`.BestFriendsEditBoxItem[${t}="${e}"]`);return s?.classList.add("BestFriendsEditBoxItem--reordered"),s}))}))}isSubmitAvailable(e){const t=e=>e?.map((e=>e)).sort(((e,t)=>e-t)).join(",");return t(e.bestFriendsIds)!==t(this.data.bestFriendsIds)&&e.bestFriendsIds.length<=B}getBatchOperationsToSave(){return[...this.data.bestFriendsIds.reduce(((e,t)=>(this.state.bestFriendsIds.includes(t)||e.push({op:_.DELETE,user_id:t}),e)),[]),...this.state.bestFriendsIds.reduce(((e,t)=>(this.data.bestFriendsIds.includes(t)||e.push({op:_.ADD,user_id:t}),e)),[])]}getFriendsIdsFromConversations(e){const t=this.data.conversationsList.find((t=>t.peerId===e));return t?t.userIds:[]}saveBestFriends(){return new Promise(((e,t)=>{const s=this.getBatchOperationsToSave();window.ajax.post("wall.php",{act:"edit_best_friends",batch:JSON.stringify(s),hash:this.data.editHash},{onDone:t=>{e(t)},onFail:e=>(t(e),!0)})}))}loadData(){return new Promise(((e,t)=>{window.ajax.post("wall.php",{act:"get_best_friends_box_data"},{onDone:(t,s,i,n)=>{e({friendsList:t,conversationsList:i,bestFriendsIds:s,editHash:n})},onFail:e=>(t(e),!0)})}))}prepareData(e){return{...e,friendsList:this.getFriendsListOrderedByFriendsIds(e.friendsList,e.bestFriendsIds)}}getConversationsIdsWhereAllFriendsExists(e){return this.data.conversationsList.reduce(((t,s)=>{for(const i of s.userIds)if(!e.includes(i))return t;return t.push(s.peerId),t}),[])}mergeFriendsLists(e,t){return Array.from(new Map([...e,...t].map((e=>[e.id,e]))).values())}mergeConversationsList(e,t){return Array.from(new Map([...e,...t].map((e=>[e.peerId,e]))).values())}getFriendsListOrderedByFriendsIds(e,t){return e.reduce(((e,s)=>(t.includes(s.id)?e.unshift(s):e.push(s),e)),[])}getConversationsListOrderedByConversationsIds(e,t){return e.reduce(((e,s)=>(t.includes(s.peerId)?e.unshift(s):e.push(s),e)),[])}getMoreConversationsCount(e,t){return Math.min(e-t,5)}render(){return r.default.preact(f,{...this.state,bestFriendsEditBoxRef:this.bestFriendsEditBoxRef,onLoadMoreConversationsClick:this.onLoadMoreConversationsClick,onClearBestFriendsButtonClick:this.onClearBestFriendsButtonClick,onSearchInputChange:this.search,onConversationActionClick:this.onConversationActionClick,onFriendActionClick:this.onFriendActionClick})}}window.BestFriendsEditBox=new class{constructor(){this.close=e=>{e&&console.error(e),this.closePopup(),r.default.handle(this.config?.onClose)}}open(e){if(this.config=e,this.editBoxPopup)return;const t=(0,n.default)({title:(0,c.getLang)("mobile_best_friends_edit_box_header"),content:f(),isLeftActionBack:!0,onLeftActionClick:"BestFriendsEditBox.close",isConfirmActionAvailable:!0}),s=r.default.elem(t);this.editBoxPopup=o.default.open(s,!0),r.default.mountPreactComponent(p,{config:this.config},this.editBoxPopup?.querySelector(".ModalPage__content"))}closePopup(){this.editBoxPopup&&(o.default.close(this.editBoxPopup),this.editBoxPopup=null)}}},73295:function(e,t,s){"use strict";s(41281);var i=s(20848);window.WallPosting=new class{constructor(){this.onFeedUploadInputChange=(e,t,s)=>{window.page.onChange((function s(){window.page.onChange("__clear",s),!window.mediaUpload.isUploading&&window.mediaUpload.start(e,t,!0)})),(0,i.statlogsValueEvent)("mvk_feed_photo_upload","upload"),window.nav.go(s)},this.onSimpleUploadInputChange=(e,t)=>{window.page.onChange((function e(){const s=document.querySelector(".inline_upload[type=file]");s.files=t,window.page.onChange("__clear",e),!window.mediaUpload.isUploading&&window.mediaUpload.start(s,void 0,!0)})),(0,i.statlogsValueEvent)("mvk_feed_photo_upload","upload"),window.nav.go(e)}}}}},function(e){"use strict";e.O(0,[1216,9522,4952,8,6320,2450,9873,5411,220,8156,7342,8040,3380,91,5333,8331,8592],(function(){return t=73295,e(e.s=t);var t}));e.O()}]);